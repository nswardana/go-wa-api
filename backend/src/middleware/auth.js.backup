const jwt = require('jsonwebtoken');
const User = require('../models/User');
const { redis } = require('../config/database');
const logger = require('../utils/logger');

const authMiddleware = async (req, res, next) => {
  try {
    // Get token from header
    const authHeader = req.header('Authorization');
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({
        error: 'Access denied',
        message: 'No token provided or invalid format'
      });
    }

    const token = authHeader.substring(7); // Remove 'Bearer ' prefix

    // Check if token is blacklisted
    try {
      const isBlacklisted = await redis.exists(`blacklist:${token}`);
      if (isBlacklisted) {
        return res.status(401).json({
          error: 'Token has been revoked',
          message: 'Please login again'
        });
      }
    } catch (redisError) {
      logger.warn('Redis blacklist check failed:', redisError);
      // Continue without Redis blacklist check
    }

    // Verify token structure
    const decoded = jwt.decode(token);
    if (!decoded || !decoded.id) {
      return res.status(401).json({
        error: 'Invalid token',
        message: 'Token structure is invalid'
      });
    }

    // Get user from cache or database
    let user;
    try {
      user = await redis.get(`session:${decoded.id}`);
      
      if (!user) {
        // If not in cache, get from database
        user = await User.findById(decoded.id);
        if (!user) {
          return res.status(401).json({
            error: 'User not found',
            message: 'Invalid token'
          });
        }

        // Cache user session
        try {
          await redis.set(`session:${decoded.id}`, user, 3600); // 1 hour
        } catch (redisError) {
          logger.warn('Redis session caching failed:', redisError);
          // Continue without Redis caching
        }
      }
    } catch (redisError) {
      logger.warn('Redis session check failed, using database:', redisError);
      // Fallback to database only
      user = await User.findById(decoded.id);
      if (!user) {
        return res.status(401).json({
          error: 'User not found',
          message: 'Invalid token'
        });
      }
    }

    // Verify token
    jwt.verify(token, user.jwt_secret || process.env.JWT_SECRET, (err, decoded) => {
      if (err) {
        logger.warn('Token verification failed:', err);
        return res.status(401).json({
          error: 'Token is not valid',
          message: 'Authentication failed'
        });
      }

      req.user = decoded;
      req.userDetails = user;
      next();
    });

  } catch (error) {
    logger.error('Auth middleware error:', error);
    res.status(500).json({
      error: 'Internal server error',
      message: 'Authentication failed'
    });
  }
};

// API Key authentication middleware
const apiKeyAuth = async (req, res, next) => {
  try {
    const apiKey = req.header('X-API-Key');
    
    if (!apiKey) {
      return res.status(401).json({
        error: 'Access denied',
        message: 'No API key provided'
      });
    }

    // Find user by API key
    const user = await User.findByApiKey(apiKey);
    if (!user) {
      return res.status(401).json({
        error: 'Invalid API key',
        message: 'Authentication failed'
      });
    }

    req.user = {
      id: user.id,
      username: user.username,
      email: user.email
    };
    req.userDetails = user;
    next();

  } catch (error) {
    logger.error('API Key auth error:', error);
    res.status(500).json({
      error: 'Internal server error',
      message: 'Authentication failed'
    });
  }
};

// Phone ownership middleware
const phoneOwnership = async (req, res, next) => {
  try {
    const userId = req.user.id;
    const phoneId = req.params.phoneId;

    // Check if phone belongs to user
    const query = 'SELECT id FROM phone_numbers WHERE id = $1 AND user_id = $2';
    const phone = await require('../config/database').db.getOne(query, [phoneId, userId]);

    if (!phone) {
      return res.status(403).json({
        error: 'Access denied',
        message: 'Phone not found or access denied'
      });
    }

    next();
  } catch (error) {
    logger.error('Phone ownership error:', error);
    res.status(500).json({
      error: 'Internal server error'
    });
  }
};

module.exports = {
  auth: authMiddleware,
  authenticateToken: authMiddleware, // Alias for consistency
  apiKey: apiKeyAuth,
  phoneOwnership
};
